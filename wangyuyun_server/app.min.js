const fs=require("fs"),path=require("path"),express=require("express"),bodyParser=require("body-parser"),request=require("./util/request"),packageJSON=require("./package.json"),exec=require("child_process").exec,cache=require("apicache").middleware,Fly=require("flyio/src/node"),jwt=require("jsonwebtoken"),fly=new Fly,app=express();app.use((req,res,next)=>{"/"===req.path||req.path.includes(".")||res.set({"Access-Control-Allow-Credentials":!0,"Access-Control-Allow-Origin":req.headers.origin||"*","Access-Control-Allow-Headers":"X-Requested-With,Content-Type","Access-Control-Allow-Methods":"PUT,POST,GET,DELETE,OPTIONS","Content-Type":"application/json; charset=utf-8"}),"OPTIONS"===req.method?res.status(204).end():next()}),app.use((req,res,next)=>{req.cookies={},(req.headers.cookie||"").split(/\s*;\s*/).forEach(pair=>{let crack=pair.indexOf("=");crack<1||crack==pair.length-1||(req.cookies[decodeURIComponent(pair.slice(0,crack)).trim()]=decodeURIComponent(pair.slice(crack+1)).trim())}),next()}),app.use(bodyParser.json()),app.use(bodyParser.urlencoded({extended:!1})),app.use(cache("2 minutes",(req,res)=>200===res.statusCode)),app.use(express.static(path.join(__dirname,"public"))),app.use("/getOpenId",async(req,res,next)=>{let code,appId,appSecret,url=`https://api.weixin.qq.com/sns/jscode2session?appid=${"wx30cf4ffe6e5b6910"}&secret=${"43f1a118bc0fd0718b187eda4eff92f4"}&js_code=${req.query.code}&grant_type=authorization_code`,result=await fly.get(url),openId=JSON.parse(result.data).openid;console.log("openId",openId);let person={username:"北方汉子",age:18,openId:openId},token=jwt.sign(person,"atguigu");console.log(token);let result2=jwt.verify(token,"atguigu");console.log(result2),res.send(token)});const special={"daily_signin.js":"/daily_signin","fm_trash.js":"/fm_trash","personal_fm.js":"/personal_fm"};fs.readdirSync(path.join(__dirname,"module")).reverse().forEach(file=>{if(!file.endsWith(".js"))return;let route=file in special?special[file]:"/"+file.replace(/\.js$/i,"").replace(/_/g,"/"),question=require(path.join(__dirname,"module",file));app.use(route,(req,res)=>{console.log(route),console.log(req),console.log("------"),console.log(req.cookies);let query=Object.assign({},req.query,req.body,{cookie:req.cookies});question(query,request).then(answer=>{console.log("[OK]",decodeURIComponent(req.originalUrl)),res.append("Set-Cookie",answer.cookie),res.status(answer.status).send(answer.body)}).catch(answer=>{console.log("[ERR]",decodeURIComponent(req.originalUrl)),"301"==answer.body.code&&(answer.body.msg="需要登录"),res.append("Set-Cookie",answer.cookie),res.status(answer.status).send(answer.body)})})});const port=process.env.PORT||3e3,host=process.env.HOST||"";app.server=app.listen(port,host,()=>{console.log("欢迎使用硅谷云音乐服务器"),console.log("服务器地址： http://localhost:3000")}),module.exports=app;